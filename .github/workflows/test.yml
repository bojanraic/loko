name: Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  unit-tests:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
        python-version: ['3.9', '3.10', '3.11', '3.12', '3.13', '3.14']

    steps:
    - uses: actions/checkout@v6

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v6
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install uv
      uses: astral-sh/setup-uv@v7

    - name: Install loko
      run: |
        uv pip install --system -e .
        uv pip install --system pytest pytest-cov pytest-timeout

    - name: Run Unit Tests
      run: |
        pytest -m "not integration" --cov=loko --cov-report=term --cov-report=html --cov-report=xml tests/

    # - name: Upload Coverage Reports
    #   if: always()
    #   uses: actions/upload-artifact@v4
    #   with:
    #     name: coverage-reports-py${{ matrix.python-version }}
    #     path: |
    #       htmlcov/
    #       coverage.xml
    #       .coverage
    #     retention-days: 7

  integration-tests-fast:
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
    - uses: actions/checkout@v6

    - name: Install mise
      uses: jdx/mise-action@v3
      with:
        install: true
        cache: true

    - name: Verify mise installation
      run: |
        mise --version
        mise list

    - name: Install loko dependencies
      run: |
        mise run install

    - name: Activate mise environment
      run: |
        eval "$(mise activate bash)"
        echo "$PATH" >> $GITHUB_PATH

    - name: Verify prerequisites
      run: |
        echo "=== Python ==="
        python --version
        echo ""
        echo "=== Kind ==="
        kind version
        echo ""
        echo "=== kubectl ==="
        kubectl version --client
        echo ""
        echo "=== Helm ==="
        helm version
        echo ""
        echo "=== Helmfile ==="
        helmfile version
        echo ""
        echo "=== mkcert ==="
        mkcert -version
        echo ""
        echo "=== Docker ==="
        docker --version
        docker info
        echo ""
        echo "=== loko ==="
        loko --version
        echo ""
        echo "=== Loko check-prerequisites ==="
        loko check-prerequisites

    - name: Run Fast Integration Tests
      run: |
        mise exec -- pytest -m 'integration and not full_cluster' -v -s

  integration-tests-full:
    runs-on: ubuntu-latest
    needs: unit-tests
    # Only run on main branch or tags
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')

    steps:
    - uses: actions/checkout@v6

    - name: Install mise
      uses: jdx/mise-action@v3
      with:
        install: true
        cache: true

    - name: Install loko dependencies
      run: |
        mise run install

    - name: Activate mise environment
      run: |
        eval "$(mise activate bash)"
        echo "$PATH" >> $GITHUB_PATH

    - name: Run Full Integration Tests
      run: |
        mise exec -- pytest -m 'integration and full_cluster' -v --tb=short -s
      timeout-minutes: 30

    - name: Cleanup Test Clusters
      if: always()
      run: |
        kind get clusters | xargs -r -n1 kind delete cluster --name || true
